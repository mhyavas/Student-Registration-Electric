{"version":3,"sources":["demo/demo_4_chat_extended.cljc"],"mappings":";AAWA,AAGA,AAEA,AAyBA","names":[],"sourcesContent":["(ns demo.demo-4-chat-extended\r\n  (:require\r\n   contrib.str\r\n   [hyperfiddle.api :as hf]\r\n   [hyperfiddle.electric :as e]\r\n   [hyperfiddle.electric-dom2 :as dom]))\r\n\r\n; Fleshed out chat demo with auth and presence\r\n; Has missionary interop, this is a more advanced demo\r\n\r\n#?(:clj (defonce !msgs (atom '())))\r\n(e/def msgs (e/server (reverse (e/watch !msgs))))\r\n\r\n#?(:clj (defonce !present (atom {}))) ; session-id -> user\r\n(e/def present (e/server (e/watch !present)))\r\n\r\n(e/defn Chat [username]\r\n  (dom/p (dom/text \"Present: \"))\r\n  (dom/ul\r\n    (e/server\r\n      (e/for [[session-id username] present]\r\n        (e/client\r\n          (dom/li (dom/text username (str \" (session-id: \" session-id \")\")))))))\r\n\r\n  (dom/hr)\r\n  (dom/ul\r\n    (e/server\r\n      (e/for [{:keys [::username ::msg]} msgs]\r\n        (e/client\r\n          (dom/li\r\n            (dom/strong (dom/text username)) (dom/text \" \" msg))))))\r\n\r\n  (dom/input\r\n    (dom/props {:placeholder \"Type a message\"})\r\n    (dom/on \"keydown\" (e/fn [e]\r\n                        (when (= \"Enter\" (.-key e))\r\n                          (when-some [v (contrib.str/empty->nil (-> e .-target .-value))]\r\n                            (dom/style {:background-color \"yellow\"})\r\n                            (e/server (swap! !msgs #(cons {::username username ::msg v} (take 9 %))))\r\n                            (set! (.-value dom/node) \"\")))))))\r\n\r\n(e/defn App []\r\n  (e/client\r\n    (dom/h1 (dom/text \"Multiplayer chat app with auth and presence\"))\r\n    (let [session-id (e/server (get-in hf/*http-request* [:headers \"sec-websocket-key\"]))\r\n          username (e/server (get-in hf/*http-request* [:cookies \"username\" :value]))]\r\n      (if-not (some? username)\r\n        (do (dom/p (dom/text \"Set login cookie here: \") (dom/a (dom/props {::dom/href \"/auth\"}) (dom/text \"/auth\")) (dom/text \" (blank password)\"))\r\n            (dom/p (dom/text \"Example HTTP endpoint is here: \")\r\n              (dom/a (dom/props {::dom/href \"https://github.com/hyperfiddle/electric/blob/master/src/hyperfiddle/electric_jetty_server.clj\"})\r\n                (dom/text \"electric_jetty_server.clj\"))))\r\n        (do\r\n          (e/server\r\n            (swap! !present assoc session-id username)\r\n            (e/on-unmount #(swap! !present dissoc session-id)))\r\n          (dom/p (dom/text \"Authenticated as: \" username))\r\n          (Chat. username))))))\r\n"]}